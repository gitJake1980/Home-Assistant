blueprint:
  name: Adaptive Lighting Scheduler
  author: danielpetrovic
  source_url: https://github.com/danielpetrovic/home-assistant-config/blob/main/blueprints/automation/danielpetrovic/adaptive-lighting-scheduler.yaml
  description: "# Adaptive Lighting Scheduler\n\nThis blueprint calculates optimal
    brightness and color temperature values throughout the day and stores them in
    input_number helpers for use by other automations and blueprints.\n\n## Key Features\n-
    **Schedule-Based**: Configure different times for each day of the week (weekdays
    vs weekends)\n- **Sun Tracking**: Optional sunrise/sunset awareness for natural
    transitions\n- **Smooth Ramping**: Gradual transitions between day phases (wake,
    morning, evening, sleep, night)\n- **Helper Output**: Stores values in input_number
    entities for use by switches, dashboards, and other automations\n- **Direct Light
    Control**: Optionally control lights directly through this blueprint. Works standalone
    without button automations, or alongside them for centralized adaptive scheduling\n-
    **Auto-Adjust**: Automatically update selected lights when schedule changes (only
    affects lights that are ON)\n- **Multiple Zones**: Create multiple instances with
    different helper pairs for different lighting zones\n\n*Each configuration option
    below includes detailed instructions in the automation editor.*\n\n## How It Works\n\nSet
    fixed times for your daily routine, with optional sun-based adjustments:\n\n-
    **Night → Wake**: Flat at night values\n- **Wake → Morning**: Ramp up to max (with
    sun tracking: waits for sunrise if after wake time)\n- **Morning → Evening**:
    Flat at max values\n- **Evening → Sleep**: Ramp down to min (optionally start
    at sunset)\n- **Sleep → Night**: Ramp down to night values\n\nEach day of the
    week has its own time settings, allowing different schedules for weekdays vs weekends.\n\nWith
    sunrise tracking enabled:\n- Summer (sunrise 05:00, wake 07:30, morning 09:00):
    Ramp 07:30 → 09:00\n- Winter (sunrise 08:47, wake 07:30, morning 09:00): Ramp
    08:47 → 09:00\n\nBrightness and color temperature values are shared across all
    days.\n\n## Example (Default Weekday Settings)\n\n| Time | Brightness | Color
    Temp | Phase |\n|------|------------|------------|-------|\n| 00:00 - 07:30 |
    25% | 2200K | Night (flat) |\n| 07:30 - 09:00 | 25% → 100% | 2200K → 4000K | Morning
    ramp |\n| 09:00 - 18:30 | 100% | 4000K | Day (flat) |\n| 18:30 - 23:30 | 100%
    → 50% | 4000K → 2700K | Evening ramp |\n| 23:30 - 00:00 | 50% → 25% | 2700K →
    2200K | Sleep ramp |\n\n## Setup\n\n### Setting up Packages (Optional)\nOrganize
    helpers into packages for easier management. Create a `packages` folder in `/config/`
    and add to your configuration:\n\n```yaml\nhomeassistant:\n  packages: !include_dir_named
    packages\n```\n\n### Helper YAML Example\nCreate `/config/packages/adaptive_lighting.yaml`
    with your helpers:\n\n```yaml\ninput_number:\n  adaptive_brightness:\n    name:
    \"Adaptive Brightness\"\n    icon: mdi:brightness-percent\n    min: 0\n    max:
    100\n    step: 1\n    unit_of_measurement: \"%\"\n  adaptive_color_temp:\n    name:
    \"Adaptive Color Temperature\"\n    icon: mdi:temperature-kelvin\n    min: 2000\n
    \   max: 6500\n    step: 100\n    unit_of_measurement: \"K\"\n```\n\nYou can create
    multiple helper pairs for different lighting zones (e.g., `adaptive_brightness_bright`
    and `adaptive_brightness_dimmed`).\n\n### GUI Alternative\nCreate two input_number
    helpers via Settings → Devices & Services → Helpers:\n- Brightness: Min 0, Max
    100, Step 1\n- Color Temperature: Min 2000, Max 6500, Step 100\n\n### After Creating
    Helpers\n\n1. Create an automation from this blueprint\n\n2. Configure times for
    each day (defaults provided for weekdays and weekends)\n\n3. Reference helpers
    in other automations or blueprints:\n   ```yaml\n   brightness_pct: \"{{ states('input_number.adaptive_brightness')
    | int }}\"\n   color_temp_kelvin: \"{{ states('input_number.adaptive_color_temp')
    | int }}\"\n   ```\n\n## Direct Light Control (Optional)\n\nYou can optionally
    select lights in the \"Direct Light Control\" section to have them automatically
    adjust based on the schedule:\n\n- **Lights to Control**: Select any lights, devices,
    or areas you want to control\n- **Enable Auto-Adjust**: Turn this on to automatically
    update lights when the schedule changes\n- **Auto-Adjust Transition**: Set how
    smoothly lights transition (default: 5 minutes)\n\n**Two ways to use this:**\n-
    **Standalone**: Perfect if you don't use button automations but still want automatic
    light adjustments throughout the day\n- **With Button Automations**: Even if you
    use the button blueprints, you can handle adaptive scheduling here instead of
    enabling auto-adjust in each button automation. This centralizes your adaptive
    lighting control in one place\n\nThe lights will only be updated when they're
    already ON - the blueprint won't turn lights on or off automatically.\n\n## Requirements\n-
    Home Assistant 2024.10.0 or later\n- Sun integration (`sun.sun` entity) for sunrise/sunset
    tracking\n"
  domain: automation
  homeassistant:
    min_version: 2024.10.0
  input:
    output_helpers:
      name: Output Helpers
      icon: mdi:export
      collapsed: false
      input:
        brightness_helper:
          name: Brightness Helper
          description: '`required` `entity`


            The input_number helper to store brightness (0-100).

            '
          selector:
            entity:
              filter:
              - domain:
                - input_number
              multiple: false
              reorder: false
        color_temp_helper:
          name: Color Temperature Helper
          description: '`required` `entity`


            The input_number helper to store color temperature (2000-6500K).

            '
          selector:
            entity:
              filter:
              - domain:
                - input_number
              multiple: false
              reorder: false
    direct_light_control:
      name: Direct Light Control
      icon: mdi:lightbulb-auto
      collapsed: true
      input:
        target_lights:
          name: Lights to Control
          default: []
          description: '`optional` `target`


            Select lights to automatically adjust based on the adaptive lighting schedule.

            These lights will be updated whenever the schedule changes.

            Leave empty if you only want to use the helper entities with other automations/blueprints.

            '
          selector:
            target:
              entity:
              - domain:
                - light
        auto_adjust_enabled:
          name: Enable Auto-Adjust
          default: false
          description: '`optional` `boolean`


            Automatically update the selected lights when adaptive values change.

            Only affects lights that are currently ON.

            '
          selector:
            boolean: {}
        auto_adjust_transition:
          name: Auto-Adjust Transition
          default: 300
          description: '`optional` `number`


            Transition duration in seconds when auto-adjusting lights.

            '
          selector:
            number:
              min: 0.0
              max: 600.0
              step: 30.0
              unit_of_measurement: s
              mode: slider
    time_settings_monday:
      name: Time Settings - Monday
      icon: mdi:calendar-today
      collapsed: true
      input:
        wake_time_mon:
          name: Wake Time
          description: '`required` `time`


            Time when morning ramp should start (or wait for sunrise if enabled).

            '
          default: 07:30:00
          selector:
            time: {}
        morning_time_mon:
          name: Morning Time
          description: '`required` `time`


            Time when brightness/color should reach maximum values.

            '
          default: 09:00:00
          selector:
            time: {}
        evening_time_mon:
          name: Evening Time
          description: '`required` `time`


            Time when evening ramp down should start (or at sunset if enabled).

            '
          default: '18:30:00'
          selector:
            time: {}
        sleep_time_mon:
          name: Sleep Time
          description: '`required` `time`


            Time when brightness/color should reach minimum values.

            '
          default: '23:30:00'
          selector:
            time: {}
        night_time_mon:
          name: Night Time
          description: '`required` `time`


            Time when brightness/color should reach night values (lowest).

            '
          default: 00:00:00
          selector:
            time: {}
    time_settings_tuesday:
      name: Time Settings - Tuesday
      icon: mdi:calendar-today
      collapsed: true
      input:
        wake_time_tue:
          name: Wake Time
          description: '`required` `time`


            Time when morning ramp should start (or wait for sunrise if enabled).

            '
          default: 07:30:00
          selector:
            time: {}
        morning_time_tue:
          name: Morning Time
          description: '`required` `time`


            Time when brightness/color should reach maximum values.

            '
          default: 09:00:00
          selector:
            time: {}
        evening_time_tue:
          name: Evening Time
          description: '`required` `time`


            Time when evening ramp down should start (or at sunset if enabled).

            '
          default: '18:30:00'
          selector:
            time: {}
        sleep_time_tue:
          name: Sleep Time
          description: '`required` `time`


            Time when brightness/color should reach minimum values.

            '
          default: '23:30:00'
          selector:
            time: {}
        night_time_tue:
          name: Night Time
          description: '`required` `time`


            Time when brightness/color should reach night values (lowest).

            '
          default: 00:00:00
          selector:
            time: {}
    time_settings_wednesday:
      name: Time Settings - Wednesday
      icon: mdi:calendar-today
      collapsed: true
      input:
        wake_time_wed:
          name: Wake Time
          description: '`required` `time`


            Time when morning ramp should start (or wait for sunrise if enabled).

            '
          default: 07:30:00
          selector:
            time: {}
        morning_time_wed:
          name: Morning Time
          description: '`required` `time`


            Time when brightness/color should reach maximum values.

            '
          default: 09:00:00
          selector:
            time: {}
        evening_time_wed:
          name: Evening Time
          description: '`required` `time`


            Time when evening ramp down should start (or at sunset if enabled).

            '
          default: '18:30:00'
          selector:
            time: {}
        sleep_time_wed:
          name: Sleep Time
          description: '`required` `time`


            Time when brightness/color should reach minimum values.

            '
          default: '23:30:00'
          selector:
            time: {}
        night_time_wed:
          name: Night Time
          description: '`required` `time`


            Time when brightness/color should reach night values (lowest).

            '
          default: 00:00:00
          selector:
            time: {}
    time_settings_thursday:
      name: Time Settings - Thursday
      icon: mdi:calendar-today
      collapsed: true
      input:
        wake_time_thu:
          name: Wake Time
          description: '`required` `time`


            Time when morning ramp should start (or wait for sunrise if enabled).

            '
          default: 07:30:00
          selector:
            time: {}
        morning_time_thu:
          name: Morning Time
          description: '`required` `time`


            Time when brightness/color should reach maximum values.

            '
          default: 09:00:00
          selector:
            time: {}
        evening_time_thu:
          name: Evening Time
          description: '`required` `time`


            Time when evening ramp down should start (or at sunset if enabled).

            '
          default: '18:30:00'
          selector:
            time: {}
        sleep_time_thu:
          name: Sleep Time
          description: '`required` `time`


            Time when brightness/color should reach minimum values.

            '
          default: '23:30:00'
          selector:
            time: {}
        night_time_thu:
          name: Night Time
          description: '`required` `time`


            Time when brightness/color should reach night values (lowest).

            '
          default: 00:00:00
          selector:
            time: {}
    time_settings_friday:
      name: Time Settings - Friday
      icon: mdi:calendar-today
      collapsed: true
      input:
        wake_time_fri:
          name: Wake Time
          description: '`required` `time`


            Time when morning ramp should start (or wait for sunrise if enabled).

            '
          default: 07:30:00
          selector:
            time: {}
        morning_time_fri:
          name: Morning Time
          description: '`required` `time`


            Time when brightness/color should reach maximum values.

            '
          default: 09:00:00
          selector:
            time: {}
        evening_time_fri:
          name: Evening Time
          description: '`required` `time`


            Time when evening ramp down should start (or at sunset if enabled).

            '
          default: '18:30:00'
          selector:
            time: {}
        sleep_time_fri:
          name: Sleep Time
          description: '`required` `time`


            Time when brightness/color should reach minimum values.

            '
          default: '23:30:00'
          selector:
            time: {}
        night_time_fri:
          name: Night Time
          description: '`required` `time`


            Time when brightness/color should reach night values (lowest).

            '
          default: 00:00:00
          selector:
            time: {}
    time_settings_saturday:
      name: Time Settings - Saturday
      icon: mdi:calendar-today
      collapsed: true
      input:
        wake_time_sat:
          name: Wake Time
          description: '`required` `time`


            Time when morning ramp should start (or wait for sunrise if enabled).

            '
          default: 08:30:00
          selector:
            time: {}
        morning_time_sat:
          name: Morning Time
          description: '`required` `time`


            Time when brightness/color should reach maximum values.

            '
          default: '10:00:00'
          selector:
            time: {}
        evening_time_sat:
          name: Evening Time
          description: '`required` `time`


            Time when evening ramp down should start (or at sunset if enabled).

            '
          default: '18:30:00'
          selector:
            time: {}
        sleep_time_sat:
          name: Sleep Time
          description: '`required` `time`


            Time when brightness/color should reach minimum values.

            '
          default: '23:30:00'
          selector:
            time: {}
        night_time_sat:
          name: Night Time
          description: '`required` `time`


            Time when brightness/color should reach night values (lowest).

            '
          default: 00:00:00
          selector:
            time: {}
    time_settings_sunday:
      name: Time Settings - Sunday
      icon: mdi:calendar-today
      collapsed: true
      input:
        wake_time_sun:
          name: Wake Time
          description: '`required` `time`


            Time when morning ramp should start (or wait for sunrise if enabled).

            '
          default: 08:30:00
          selector:
            time: {}
        morning_time_sun:
          name: Morning Time
          description: '`required` `time`


            Time when brightness/color should reach maximum values.

            '
          default: '10:00:00'
          selector:
            time: {}
        evening_time_sun:
          name: Evening Time
          description: '`required` `time`


            Time when evening ramp down should start (or at sunset if enabled).

            '
          default: '18:30:00'
          selector:
            time: {}
        sleep_time_sun:
          name: Sleep Time
          description: '`required` `time`


            Time when brightness/color should reach minimum values.

            '
          default: '23:30:00'
          selector:
            time: {}
        night_time_sun:
          name: Night Time
          description: '`required` `time`


            Time when brightness/color should reach night values (lowest).

            '
          default: 00:00:00
          selector:
            time: {}
    brightness_settings:
      name: Brightness Values
      icon: mdi:brightness-percent
      collapsed: true
      input:
        max_brightness:
          name: Maximum Brightness
          default: 100
          description: '`required` `number`


            Brightness at morning time (daytime maximum).

            '
          selector:
            number:
              min: 1.0
              max: 100.0
              step: 5.0
              unit_of_measurement: '%'
              mode: slider
        min_brightness:
          name: Minimum Brightness
          default: 50
          description: '`required` `number`


            Brightness at sleep time (evening).

            '
          selector:
            number:
              min: 1.0
              max: 100.0
              step: 5.0
              unit_of_measurement: '%'
              mode: slider
        night_brightness:
          name: Night Brightness
          default: 25
          description: '`required` `number`


            Brightness at night time (lowest).

            '
          selector:
            number:
              min: 1.0
              max: 100.0
              step: 5.0
              unit_of_measurement: '%'
              mode: slider
    color_temp_settings:
      name: Color Temperature Values
      icon: mdi:thermometer
      collapsed: true
      input:
        max_color_temp:
          name: Maximum Color Temperature
          default: 4000
          description: '`required` `color_temp`


            Color temperature at morning time (coolest/daylight).

            '
          selector:
            color_temp:
              unit: kelvin
              min: 2000
              max: 6500
        min_color_temp:
          name: Minimum Color Temperature
          default: 2700
          description: '`required` `color_temp`


            Color temperature at sleep time (warm).

            '
          selector:
            color_temp:
              unit: kelvin
              min: 2000
              max: 6500
        night_color_temp:
          name: Night Color Temperature
          default: 2200
          description: '`required` `color_temp`


            Color temperature at night time (warmest).

            '
          selector:
            color_temp:
              unit: kelvin
              min: 2000
              max: 6500
    sun_settings_brightness:
      name: Sun Settings - Brightness
      icon: mdi:white-balance-sunny
      collapsed: true
      input:
        brightness_use_sunrise:
          name: Wait for Sunrise
          default: false
          description: '`optional` `boolean`


            Don''t start morning ramp until sunrise (if sunrise is after wake time).

            Prevents reaching max brightness before the sun is up.

            '
          selector:
            boolean: {}
        brightness_use_sunset:
          name: Start Dimming at Sunset
          default: false
          description: '`optional` `boolean`


            Start evening ramp at sunset if it''s before evening time.

            '
          selector:
            boolean: {}
    sun_settings_color:
      name: Sun Settings - Color Temperature
      icon: mdi:theme-light-dark
      collapsed: true
      input:
        color_use_sunrise:
          name: Wait for Sunrise
          default: true
          description: '`optional` `boolean`


            Don''t start morning ramp until sunrise (if sunrise is after wake time).

            Prevents reaching max color temp before the sun is up.

            '
          selector:
            boolean: {}
        color_use_sunset:
          name: Start Warming at Sunset
          default: true
          description: '`optional` `boolean`


            Start evening ramp at sunset if it''s before evening time.

            Useful in winter when it gets dark before your evening routine.

            '
          selector:
            boolean: {}
    sun_offsets:
      name: Sun Offsets
      icon: mdi:sun-clock
      collapsed: true
      input:
        sunrise_offset:
          name: Sunrise Offset
          default: 0
          description: '`optional` `number`


            Minutes to offset from sunrise. Positive = later, negative = earlier.

            '
          selector:
            number:
              min: -120.0
              max: 120.0
              step: 15.0
              unit_of_measurement: min
              mode: slider
        sunset_offset:
          name: Sunset Offset
          default: 0
          description: '`optional` `number`


            Minutes to offset from sunset. Positive = later, negative = earlier.

            '
          selector:
            number:
              min: -120.0
              max: 120.0
              step: 15.0
              unit_of_measurement: min
              mode: slider
    dashboard_scripts:
      name: Dashboard Example - Scripts
      description: "Add these scripts to `/config/packages/adaptive_lighting.yaml`
        (or `scripts.yaml`):\n\n```yaml\nscript:\n  lights_preset_off:\n    alias:
        \"Lights - Off\"\n    fields:\n      target_light:\n        required: true\n
        \       selector:\n          entity:\n            domain: light\n    sequence:\n
        \     - action: light.turn_off\n        target:\n          entity_id: \"{{
        target_light }}\"\n\n  lights_preset_25:\n    alias: \"Lights - 25%\"\n    fields:\n
        \     target_light:\n        required: true\n        selector:\n          entity:\n
        \           domain: light\n    sequence:\n      - action: light.turn_on\n
        \       target:\n          entity_id: \"{{ target_light }}\"\n        data:\n
        \         brightness_pct: 25\n          color_temp_kelvin: \"{{ states('input_number.adaptive_color_temp')
        | int }}\"\n\n  lights_preset_50:\n    alias: \"Lights - 50%\"\n    fields:\n
        \     target_light:\n        required: true\n        selector:\n          entity:\n
        \           domain: light\n    sequence:\n      - action: light.turn_on\n
        \       target:\n          entity_id: \"{{ target_light }}\"\n        data:\n
        \         brightness_pct: 50\n          color_temp_kelvin: \"{{ states('input_number.adaptive_color_temp')
        | int }}\"\n\n  lights_preset_100:\n    alias: \"Lights - 100%\"\n    fields:\n
        \     target_light:\n        required: true\n        selector:\n          entity:\n
        \           domain: light\n    sequence:\n      - action: light.turn_on\n
        \       target:\n          entity_id: \"{{ target_light }}\"\n        data:\n
        \         brightness_pct: 100\n          color_temp_kelvin: \"{{ states('input_number.adaptive_color_temp')
        | int }}\"\n\n  lights_preset_adaptive:\n    alias: \"Lights - Adaptive\"\n
        \   fields:\n      target_light:\n        required: true\n        selector:\n
        \         entity:\n            domain: light\n    sequence:\n      - action:
        light.turn_on\n        target:\n          entity_id: \"{{ target_light }}\"\n
        \       data:\n          brightness_pct: \"{{ states('input_number.adaptive_brightness')
        | int }}\"\n          color_temp_kelvin: \"{{ states('input_number.adaptive_color_temp')
        | int }}\"\n\n  lights_preset_adaptive_color:\n    alias: \"Lights - Adaptive
        Color\"\n    fields:\n      target_light:\n        required: true\n        selector:\n
        \         entity:\n            domain: light\n    sequence:\n      - action:
        light.turn_on\n        target:\n          entity_id: \"{{ target_light }}\"\n
        \       data:\n          color_temp_kelvin: \"{{ states('input_number.adaptive_color_temp')
        | int }}\"\n```\n"
      icon: mdi:script-text
      collapsed: true
      input: {}
    dashboard_lovelace:
      name: Dashboard Example - Lovelace Card
      description: "Add this card to your dashboard (replace `light.living_room` with
        your light):\n\n```yaml\ntype: vertical-stack\ncards:\n  - type: tile\n    entity:
        light.living_room\n    features:\n      - type: light-brightness\n  - type:
        grid\n    columns: 5\n    square: false\n    cards:\n      - type: button\n
        \       icon: mdi:lightbulb-off-outline\n        tap_action:\n          action:
        call-service\n          service: script.lights_preset_off\n          data:\n
        \           target_light: light.living_room\n      - type: button\n        icon:
        mdi:lightbulb-on-10\n        tap_action:\n          action: call-service\n
        \         service: script.lights_preset_25\n          data:\n            target_light:
        light.living_room\n      - type: button\n        icon: mdi:lightbulb-on-40\n
        \       tap_action:\n          action: call-service\n          service: script.lights_preset_50\n
        \         data:\n            target_light: light.living_room\n      - type:
        button\n        icon: mdi:lightbulb-on\n        tap_action:\n          action:
        call-service\n          service: script.lights_preset_100\n          data:\n
        \           target_light: light.living_room\n      - type: button\n        icon:
        mdi:lightbulb-auto\n        entity: light.living_room\n        tap_action:\n
        \         action: call-service\n          service: script.lights_preset_adaptive\n
        \         data:\n            target_light: light.living_room\n  - type: grid\n
        \   columns: 5\n    square: false\n    cards:\n      - type: button\n        icon:
        mdi:lightbulb\n        color: deep-orange\n        tap_action:\n          action:
        call-service\n          service: light.turn_on\n          data:\n            color_temp_kelvin:
        2200\n          target:\n            entity_id: light.living_room\n      -
        type: button\n        icon: mdi:lightbulb\n        color: orange\n        tap_action:\n
        \         action: call-service\n          service: light.turn_on\n          data:\n
        \           color_temp_kelvin: 2700\n          target:\n            entity_id:
        light.living_room\n      - type: button\n        icon: mdi:lightbulb\n        color:
        amber\n        tap_action:\n          action: call-service\n          service:
        light.turn_on\n          data:\n            color_temp_kelvin: 3500\n          target:\n
        \           entity_id: light.living_room\n      - type: button\n        icon:
        mdi:lightbulb\n        color: white\n        tap_action:\n          action:
        call-service\n          service: light.turn_on\n          data:\n            color_temp_kelvin:
        4000\n          target:\n            entity_id: light.living_room\n      -
        type: button\n        icon: mdi:lightbulb-auto-outline\n        entity: light.living_room\n
        \       tap_action:\n          action: call-service\n          service: script.lights_preset_adaptive_color\n
        \         data:\n            target_light: light.living_room\n```\n"
      icon: mdi:view-dashboard
      collapsed: true
      input: {}
variables:
  brightness_helper: !input brightness_helper
  color_temp_helper: !input color_temp_helper
  target_lights: !input target_lights
  auto_adjust_enabled: !input auto_adjust_enabled
  auto_adjust_transition: !input auto_adjust_transition
  has_light_target: '{{ target_lights.entity_id | default([]) | length > 0 or target_lights.device_id
    | default([]) | length > 0 or target_lights.area_id | default([]) | length > 0
    }}'
  light_entities: "{% set ns = namespace(entities=[]) %} {% if target_lights.entity_id
    is defined and target_lights.entity_id | length > 0 %}\n  {% if target_lights.entity_id
    is string %}\n    {% set ns.entities = [target_lights.entity_id] %}\n  {% else
    %}\n    {% set ns.entities = target_lights.entity_id %}\n  {% endif %}\n{% elif
    target_lights.device_id is defined and target_lights.device_id | length > 0 %}\n
    \ {% set devices = [target_lights.device_id] if target_lights.device_id is string
    else target_lights.device_id %}\n  {% for device in devices %}\n    {% set ns.entities
    = ns.entities + device_entities(device) | select('match', '^light\\.') | list
    %}\n  {% endfor %}\n{% elif target_lights.area_id is defined and target_lights.area_id
    | length > 0 %}\n  {% set areas = [target_lights.area_id] if target_lights.area_id
    is string else target_lights.area_id %}\n  {% for area in areas %}\n    {% set
    ns.entities = ns.entities + area_entities(area) | select('match', '^light\\.')
    | list %}\n  {% endfor %}\n{% endif %} {{ ns.entities }}"
  max_brightness: !input max_brightness
  min_brightness: !input min_brightness
  night_brightness: !input night_brightness
  max_color_temp: !input max_color_temp
  min_color_temp: !input min_color_temp
  night_color_temp: !input night_color_temp
  brightness_use_sunrise: !input brightness_use_sunrise
  brightness_use_sunset: !input brightness_use_sunset
  color_use_sunrise: !input color_use_sunrise
  color_use_sunset: !input color_use_sunset
  sunrise_offset: !input sunrise_offset
  sunset_offset: !input sunset_offset
  wake_time_mon: !input wake_time_mon
  morning_time_mon: !input morning_time_mon
  evening_time_mon: !input evening_time_mon
  sleep_time_mon: !input sleep_time_mon
  night_time_mon: !input night_time_mon
  wake_time_tue: !input wake_time_tue
  morning_time_tue: !input morning_time_tue
  evening_time_tue: !input evening_time_tue
  sleep_time_tue: !input sleep_time_tue
  night_time_tue: !input night_time_tue
  wake_time_wed: !input wake_time_wed
  morning_time_wed: !input morning_time_wed
  evening_time_wed: !input evening_time_wed
  sleep_time_wed: !input sleep_time_wed
  night_time_wed: !input night_time_wed
  wake_time_thu: !input wake_time_thu
  morning_time_thu: !input morning_time_thu
  evening_time_thu: !input evening_time_thu
  sleep_time_thu: !input sleep_time_thu
  night_time_thu: !input night_time_thu
  wake_time_fri: !input wake_time_fri
  morning_time_fri: !input morning_time_fri
  evening_time_fri: !input evening_time_fri
  sleep_time_fri: !input sleep_time_fri
  night_time_fri: !input night_time_fri
  wake_time_sat: !input wake_time_sat
  morning_time_sat: !input morning_time_sat
  evening_time_sat: !input evening_time_sat
  sleep_time_sat: !input sleep_time_sat
  night_time_sat: !input night_time_sat
  wake_time_sun: !input wake_time_sun
  morning_time_sun: !input morning_time_sun
  evening_time_sun: !input evening_time_sun
  sleep_time_sun: !input sleep_time_sun
  night_time_sun: !input night_time_sun
  wake_time: '{% set day = now().weekday() %} {% if day == 0 %}{{ wake_time_mon }}
    {% elif day == 1 %}{{ wake_time_tue }} {% elif day == 2 %}{{ wake_time_wed }}
    {% elif day == 3 %}{{ wake_time_thu }} {% elif day == 4 %}{{ wake_time_fri }}
    {% elif day == 5 %}{{ wake_time_sat }} {% else %}{{ wake_time_sun }}{% endif %}'
  morning_time: '{% set day = now().weekday() %} {% if day == 0 %}{{ morning_time_mon
    }} {% elif day == 1 %}{{ morning_time_tue }} {% elif day == 2 %}{{ morning_time_wed
    }} {% elif day == 3 %}{{ morning_time_thu }} {% elif day == 4 %}{{ morning_time_fri
    }} {% elif day == 5 %}{{ morning_time_sat }} {% else %}{{ morning_time_sun }}{%
    endif %}'
  evening_time: '{% set day = now().weekday() %} {% if day == 0 %}{{ evening_time_mon
    }} {% elif day == 1 %}{{ evening_time_tue }} {% elif day == 2 %}{{ evening_time_wed
    }} {% elif day == 3 %}{{ evening_time_thu }} {% elif day == 4 %}{{ evening_time_fri
    }} {% elif day == 5 %}{{ evening_time_sat }} {% else %}{{ evening_time_sun }}{%
    endif %}'
  sleep_time: '{% set day = now().weekday() %} {% if day == 0 %}{{ sleep_time_mon
    }} {% elif day == 1 %}{{ sleep_time_tue }} {% elif day == 2 %}{{ sleep_time_wed
    }} {% elif day == 3 %}{{ sleep_time_thu }} {% elif day == 4 %}{{ sleep_time_fri
    }} {% elif day == 5 %}{{ sleep_time_sat }} {% else %}{{ sleep_time_sun }}{% endif
    %}'
  night_time: '{% set day = now().weekday() %} {% if day == 0 %}{{ night_time_mon
    }} {% elif day == 1 %}{{ night_time_tue }} {% elif day == 2 %}{{ night_time_wed
    }} {% elif day == 3 %}{{ night_time_thu }} {% elif day == 4 %}{{ night_time_fri
    }} {% elif day == 5 %}{{ night_time_sat }} {% else %}{{ night_time_sun }}{% endif
    %}'
  calculated_brightness: "{% set now_ts = now().timestamp() %} {% set today_midnight
    = today_at('00:00').timestamp() %} {% set next_midnight = today_midnight + 86400
    %}\n{# Parse times #} {% set wake_parts = wake_time.split(':') %} {% set wake_ts
    = today_at(wake_parts[0] ~ ':' ~ wake_parts[1]).timestamp() %} {% set morning_parts
    = morning_time.split(':') %} {% set morning_ts = today_at(morning_parts[0] ~ ':'
    ~ morning_parts[1]).timestamp() %} {% set evening_parts = evening_time.split(':')
    %} {% set evening_ts = today_at(evening_parts[0] ~ ':' ~ evening_parts[1]).timestamp()
    %} {% set sleep_parts = sleep_time.split(':') %} {% set sleep_ts = today_at(sleep_parts[0]
    ~ ':' ~ sleep_parts[1]).timestamp() %} {% set night_parts = night_time.split(':')
    %} {% set night_ts = today_at(night_parts[0] ~ ':' ~ night_parts[1]).timestamp()
    %}\n{# Handle night_time being after midnight (e.g., 00:30) #} {% if night_ts
    <= sleep_ts %}\n  {% set night_ts = night_ts + 86400 %}\n{% endif %}\n{# Get sun
    times #} {% set next_sunrise = (state_attr('sun.sun', 'next_rising') | as_datetime).timestamp()
    %} {% set next_sunset = (state_attr('sun.sun', 'next_setting') | as_datetime).timestamp()
    %} {% set today_sunrise = next_sunrise if next_sunrise < next_midnight else next_sunrise
    - 86400 %} {% set today_sunset = next_sunset if next_sunset < next_midnight else
    next_sunset - 86400 %} {% set sunrise_ts = today_sunrise + (sunrise_offset | int
    * 60) %} {% set sunset_ts = today_sunset + (sunset_offset | int * 60) %}\n{# Determine
    morning ramp start #} {# With sunrise tracking: start at later of wake_time or
    sunrise #} {# Without sunrise tracking: start at wake_time #} {% if brightness_use_sunrise
    %}\n  {% set morning_start = [wake_ts, sunrise_ts] | max %}\n{% else %}\n  {%
    set morning_start = wake_ts %}\n{% endif %}\n{# Morning ramp ends at morning_time
    #} {% set morning_end = morning_ts %}\n{# Determine evening ramp start #} {% if
    brightness_use_sunset and sunset_ts < evening_ts %}\n  {% set evening_start =
    sunset_ts %}\n{% else %}\n  {% set evening_start = evening_ts %}\n{% endif %}\n{#
    Calculate brightness #} {% if now_ts < morning_start %}\n  {{ night_brightness
    }}\n{% elif now_ts < morning_end %}\n  {% set p = (now_ts - morning_start) / (morning_end
    - morning_start) %}\n  {% set p = [0, [1, p] | min] | max %}\n  {{ (night_brightness
    + (max_brightness - night_brightness) * p) | round(0) }}\n{% elif now_ts < evening_start
    %}\n  {{ max_brightness }}\n{% elif now_ts < sleep_ts %}\n  {% set p = (now_ts
    - evening_start) / (sleep_ts - evening_start) %}\n  {% set p = [0, [1, p] | min]
    | max %}\n  {{ (max_brightness - (max_brightness - min_brightness) * p) | round(0)
    }}\n{% elif now_ts < night_ts %}\n  {% set p = (now_ts - sleep_ts) / (night_ts
    - sleep_ts) %}\n  {% set p = [0, [1, p] | min] | max %}\n  {{ (min_brightness
    - (min_brightness - night_brightness) * p) | round(0) }}\n{% else %}\n  {{ night_brightness
    }}\n{% endif %}"
  calculated_color_temp: "{% set now_ts = now().timestamp() %} {% set today_midnight
    = today_at('00:00').timestamp() %} {% set next_midnight = today_midnight + 86400
    %}\n{# Parse times #} {% set wake_parts = wake_time.split(':') %} {% set wake_ts
    = today_at(wake_parts[0] ~ ':' ~ wake_parts[1]).timestamp() %} {% set morning_parts
    = morning_time.split(':') %} {% set morning_ts = today_at(morning_parts[0] ~ ':'
    ~ morning_parts[1]).timestamp() %} {% set evening_parts = evening_time.split(':')
    %} {% set evening_ts = today_at(evening_parts[0] ~ ':' ~ evening_parts[1]).timestamp()
    %} {% set sleep_parts = sleep_time.split(':') %} {% set sleep_ts = today_at(sleep_parts[0]
    ~ ':' ~ sleep_parts[1]).timestamp() %} {% set night_parts = night_time.split(':')
    %} {% set night_ts = today_at(night_parts[0] ~ ':' ~ night_parts[1]).timestamp()
    %}\n{# Handle night_time being after midnight (e.g., 00:30) #} {% if night_ts
    <= sleep_ts %}\n  {% set night_ts = night_ts + 86400 %}\n{% endif %}\n{# Get sun
    times #} {% set next_sunrise = (state_attr('sun.sun', 'next_rising') | as_datetime).timestamp()
    %} {% set next_sunset = (state_attr('sun.sun', 'next_setting') | as_datetime).timestamp()
    %} {% set today_sunrise = next_sunrise if next_sunrise < next_midnight else next_sunrise
    - 86400 %} {% set today_sunset = next_sunset if next_sunset < next_midnight else
    next_sunset - 86400 %} {% set sunrise_ts = today_sunrise + (sunrise_offset | int
    * 60) %} {% set sunset_ts = today_sunset + (sunset_offset | int * 60) %}\n{# Determine
    morning ramp start #} {# With sunrise tracking: start at later of wake_time or
    sunrise #} {# Without sunrise tracking: start at wake_time #} {% if color_use_sunrise
    %}\n  {% set morning_start = [wake_ts, sunrise_ts] | max %}\n{% else %}\n  {%
    set morning_start = wake_ts %}\n{% endif %}\n{# Morning ramp ends at morning_time
    #} {% set morning_end = morning_ts %}\n{# Determine evening ramp start #} {% if
    color_use_sunset and sunset_ts < evening_ts %}\n  {% set evening_start = sunset_ts
    %}\n{% else %}\n  {% set evening_start = evening_ts %}\n{% endif %}\n{# Calculate
    color temp #} {% if now_ts < morning_start %}\n  {{ night_color_temp }}\n{% elif
    now_ts < morning_end %}\n  {% set p = (now_ts - morning_start) / (morning_end
    - morning_start) %}\n  {% set p = [0, [1, p] | min] | max %}\n  {{ (night_color_temp
    + (max_color_temp - night_color_temp) * p) | round(0) }}\n{% elif now_ts < evening_start
    %}\n  {{ max_color_temp }}\n{% elif now_ts < sleep_ts %}\n  {% set p = (now_ts
    - evening_start) / (sleep_ts - evening_start) %}\n  {% set p = [0, [1, p] | min]
    | max %}\n  {{ (max_color_temp - (max_color_temp - min_color_temp) * p) | round(0)
    }}\n{% elif now_ts < night_ts %}\n  {% set p = (now_ts - sleep_ts) / (night_ts
    - sleep_ts) %}\n  {% set p = [0, [1, p] | min] | max %}\n  {{ (min_color_temp
    - (min_color_temp - night_color_temp) * p) | round(0) }}\n{% else %}\n  {{ night_color_temp
    }}\n{% endif %}"
triggers:
- trigger: time_pattern
  minutes: /5
- trigger: state
  entity_id: sun.sun
- trigger: homeassistant
  event: start
actions:
- action: input_number.set_value
  target:
    entity_id: '{{ brightness_helper }}'
  data:
    value: '{{ calculated_brightness }}'
- action: input_number.set_value
  target:
    entity_id: '{{ color_temp_helper }}'
  data:
    value: '{{ calculated_color_temp }}'
- if:
  - '{{ auto_adjust_enabled and has_light_target }}'
  then:
  - repeat:
      for_each: '{{ light_entities }}'
      sequence:
      - if:
        - '{{ is_state(repeat.item, ''on'') }}'
        then:
        - action: light.turn_on
          target:
            entity_id: '{{ repeat.item }}'
          data:
            brightness_pct: '{{ calculated_brightness }}'
            color_temp_kelvin: '{{ calculated_color_temp }}'
            transition: '{{ auto_adjust_transition }}'
