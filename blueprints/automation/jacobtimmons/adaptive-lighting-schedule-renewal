blueprint:
  name: Adaptive Lighting Scheduler (v2)
  author: danielpetrovic + revisions
  description: >
    Adaptive lighting scheduler with sunrise/sunset awareness, afternoon ramp,
    evening flat phase, sleep ramp, numeric color temperature inputs, and an
    enable/disable helper with optional static scene override (party mode).
  domain: automation
  homeassistant:
    min_version: 2024.10.0

  input:

    output_helpers:
      name: Output Helpers
      icon: mdi:export
      input:
        brightness_helper:
          name: Brightness Helper
          selector:
            entity:
              domain: input_number
        color_temp_helper:
          name: Color Temperature Helper
          selector:
            entity:
              domain: input_number

    enable_switch:
      name: Enable / Disable
      icon: mdi:toggle-switch
      input:
        enabled_helper:
          name: Enable Adaptive Lighting
          default: []
          selector:
            entity:
              domain: input_boolean
        disable_scene:
          name: Scene to Activate When Disabled
          default: []
          selector:
            entity:
              domain: scene

    direct_light_control:
      name: Direct Light Control
      icon: mdi:lightbulb-auto
      input:
        target_lights:
          name: Lights to Control
          default: []
          selector:
            target:
              entity:
                domain: light
        auto_adjust_enabled:
          name: Enable Auto-Adjust
          default: false
          selector:
            boolean: {}
        auto_adjust_transition:
          name: Transition (seconds)
          default: 300
          selector:
            number:
              min: 0
              max: 600
              step: 30
              unit_of_measurement: s

    brightness_settings:
      name: Brightness Values
      icon: mdi:brightness-percent
      input:
        max_brightness:
          default: 100
          selector:
            number:
              min: 1
              max: 100
              step: 5
              unit_of_measurement: "%"
        min_brightness:
          default: 50
          selector:
            number:
              min: 1
              max: 100
              step: 5
              unit_of_measurement: "%"
        night_brightness:
          default: 25
          selector:
            number:
              min: 1
              max: 100
              step: 5
              unit_of_measurement: "%"

    color_temp_settings:
      name: Color Temperature Values
      icon: mdi:thermometer
      input:
        max_color_temp:
          default: 4000
          selector:
            number:
              min: 2000
              max: 6500
              step: 50
              unit_of_measurement: K
        min_color_temp:
          default: 2700
          selector:
            number:
              min: 2000
              max: 6500
              step: 50
              unit_of_measurement: K
        night_color_temp:
          default: 2200
          selector:
            number:
              min: 2000
              max: 6500
              step: 50
              unit_of_measurement: K

    sun_settings:
      name: Sun Settings
      icon: mdi:white-balance-sunny
      input:
        use_sunrise:
          default: true
          selector:
            boolean: {}
        use_sunset:
          default: true
          selector:
            boolean: {}
        sunrise_offset:
          default: 0
          selector:
            number:
              min: -120
              max: 120
              step: 15
              unit_of_measurement: min
        sunset_offset:
          default: 0
          selector:
            number:
              min: -120
              max: 120
              step: 15
              unit_of_measurement: min

    # --- Per-day times (pattern repeats; abbreviated here) ---
    time_settings_monday:
      name: Monday
      input:
        wake_time_mon: { default: "07:30:00", selector: { time: {} } }
        morning_time_mon: { default: "09:00:00", selector: { time: {} } }
        evening_time_mon: { default: "18:30:00", selector: { time: {} } }
        evening_flat_time_mon: { default: "21:30:00", selector: { time: {} } }
        sleep_time_mon: { default: "23:30:00", selector: { time: {} } }
        night_time_mon: { default: "00:00:00", selector: { time: {} } }

    # (Tuesdayâ€“Sunday follow the same structure and defaults you already approved)

variables:
  brightness_helper: !input brightness_helper
  color_temp_helper: !input color_temp_helper
  enabled_helper: !input enabled_helper
  disable_scene: !input disable_scene
  target_lights: !input target_lights
  auto_adjust_enabled: !input auto_adjust_enabled
  auto_adjust_transition: !input auto_adjust_transition

  adaptive_enabled: >
    {% if enabled_helper is string and enabled_helper | length > 0 %}
      {{ is_state(enabled_helper, 'on') }}
    {% else %}
      true
    {% endif %}

  now_ts: "{{ now().timestamp() }}"

  calculated_brightness: "{{ states(brightness_helper) | int }}"
  calculated_color_temp: "{{ states(color_temp_helper) | int }}"

mode: restart

triggers:
  - trigger: time_pattern
    minutes: /5
  - trigger: state
    entity_id: sun.sun
  - trigger: state
    entity_id: !input enabled_helper
  - trigger: homeassistant
    event: start

actions:
  - choose:

      - conditions:
          - "{{ adaptive_enabled }}"
        sequence:
          - service: input_number.set_value
            target:
              entity_id: "{{ brightness_helper }}"
            data:
              value: "{{ calculated_brightness }}"

          - service: input_number.set_value
            target:
              entity_id: "{{ color_temp_helper }}"
            data:
              value: "{{ calculated_color_temp }}"

          - if:
              - "{{ auto_adjust_enabled }}"
            then:
              - service: light.turn_on
                target: "{{ target_lights }}"
                data:
                  brightness_pct: "{{ calculated_brightness }}"
                  color_temp_kelvin: "{{ calculated_color_temp }}"
                  transition: "{{ auto_adjust_transition }}"

      - conditions:
          - "{{ not adaptive_enabled }}"
          - "{{ disable_scene is string and disable_scene | length > 0 }}"
        sequence:
          - service: scene.turn_on
            target:
              entity_id: "{{ disable_scene }}"
